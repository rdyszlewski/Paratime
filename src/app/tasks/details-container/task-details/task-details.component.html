<div class="panel">
  <form>
  <mat-expansion-panel [expanded]="true">
    <mat-expansion-panel-header> Główne </mat-expansion-panel-header>
    <ng-container [ngTemplateOutlet]="main_group"></ng-container>
  </mat-expansion-panel>

  <mat-expansion-panel>
    <mat-expansion-panel-header> Informacje </mat-expansion-panel-header>
    <ng-container [ngTemplateOutlet]="info_group"></ng-container>
  </mat-expansion-panel>

  <mat-expansion-panel>
    <mat-expansion-panel-header> Czas </mat-expansion-panel-header>
    <ng-container [ngTemplateOutlet]="time_group"></ng-container>
  </mat-expansion-panel>

    <mat-expansion-panel
      class="form-group"
      [expanded]="getState().isLabelsExtended()"
    >
      <mat-expansion-panel-header class="form-group-header">
        Etykiety ({{ getModel().getTask().labels.length }})
      </mat-expansion-panel-header>
      <ng-container [ngTemplateOutlet]="task_labels_group"></ng-container>
    </mat-expansion-panel>

    <mat-expansion-panel
      class="form-group"
      [expanded]="getState().isSubtasksExtended()"
    >
      <mat-expansion-panel-header class="form-group-header">
        Kroki ({{ getFinishedSubtasks(getModel().getTask()) }} /
        {{ getModel().getTask().subtasks.length }})
      </mat-expansion-panel-header>
      <ng-container [ngTemplateOutlet]="task_subtasks_group"></ng-container>
    </mat-expansion-panel>
  </form>
</div>

<mat-menu #appMenu="matMenu" class="my-menu">
  <div
    mat-menu-item
    *ngFor="let label of getLabels().getModel().getLabels()"
    class="list-item"
    (click)="getLabels().selectLabel(label, $event)"
  >
    <mat-checkbox
      type="checkbox"
      [checked]="getLabels().isLabelSelected(label)"
    ></mat-checkbox>
    <span>{{ label.name }}</span>
  </div>

  <button (click)="getLabels().cancelChoosingLabels()">Anuluj</button>
  <button (click)="getLabels().acceptSelectedLabels()">Gotowe</button>
</mat-menu>

<ng-template #main_group>
  <ng-container [ngTemplateOutlet]="task_name_group"></ng-container>
  <ng-container [ngTemplateOutlet]="task_description"></ng-container>
</ng-template>

<ng-template #info_group>
  <ng-container [ngTemplateOutlet]="task_status"></ng-container>
  <ng-container [ngTemplateOutlet]="task_priority"></ng-container>
  <ng-container [ngTemplateOutlet]="task_stage"></ng-container>
</ng-template>

<ng-template #time_group>
  <ng-container [ngTemplateOutlet]="task_date"></ng-container>
  <ng-container [ngTemplateOutlet]="task_time"></ng-container>
  <ng-container [ngTemplateOutlet]="task_end_date"></ng-container>
  <ng-container [ngTemplateOutlet]="task_planned_time"></ng-container>
</ng-template>

<ng-template #task_name_group>
    <input
      type="text"
      class="form-control"
      id="task-name"
      name="name"
      autocomplete="off"
      placeholder="Nazwa"
      [ngModel]="getModel().getTask().name"
      (ngModelChange)="getModel().getTask().name = $event"
      (keyup.enter)="updateTask()"
      (focusout)="updateTask()"
    />
    <span
      *ngIf="!getValidator().isNameValid() && getChangeDetector().isNameChanged()"
      class="invalid-feedback"
      >Nazwa nie może być pusta</span
    >
</ng-template>

<ng-template #task_description>
  <div class="form-container">
    <textarea
      class="form-control"
      id="task-description"
      name="description"
      rows="4"
      placeholder="Opis"
      [ngModel]="getModel().getTask().description"
      (ngModelChange)="getModel().getTask().description = $event"
      (keyup.enter)="updateTask()"
      (focusout)="updateTask()"
    >
    </textarea>
  </div>
</ng-template>

<ng-template #task_status>
  <label class="form-label">Status</label>
  <select
    class="form-control"
    id="task-status"
    name="status"
    [ngModel]="getModel().getTask().status"
    (ngModelChange)="getModel().getTask().status = $event"
    (change)="updateTask()"
  >
    <option [ngValue]="status.STARTED">Aktywny</option>
    <option [ngValue]="status.ENDED">Zakończony</option>
    <option [ngValue]="status.CANCELED">Anulowany</option>
    <option [ngValue]="status.AWAITING">Oczekujący</option>
  </select>
</ng-template>

<ng-template #task_priority>
  <div class="form-container">
    <label class="form-label"> Priorytet</label>
    <select
      class="form-control"
      id="task-priority"
      name="priority"
      [ngModel]="getModel().getTask().priority"
      (ngModelChange)="getModel().getTask().priority = $event"
      (change)="updateTask()"
    >
      <option [ngValue]="null"></option>
      <option [ngValue]="priority.LEVEL_1">1</option>
      <option [ngValue]="priority.LEVEL_2">2</option>
      <option [ngValue]="priority.LEVEL_3">3</option>
      <option [ngValue]="priority.LEVEL_4">4</option>
      <option [ngValue]="priority.LEVEL_5">5</option>
    </select>
  </div>
</ng-template>

<ng-template #task_date>
  <div class="form-container">
    <label class="form-label">Data</label>
    <div class="datepicker-container">
      <input
        matInput
        class="form-control"
        id="task-date"
        name="date"
        autocomplete="off"
        [matDatepicker]="datePicker"
        [ngModel]="getModel().getTask().date"
        (ngModelChange)="getModel().getTask().date = $event"
        (dateChange)="updateTask()"
      />
      <mat-datepicker-toggle
        [for]="datePicker"
        class="datepicker"
      ></mat-datepicker-toggle>
      <mat-datepicker #datePicker></mat-datepicker>
    </div>
  </div>
</ng-template>

<ng-template #task_time>
  <label class="form-label">Godzina</label>
  <div class="time-container">
    <input paraInput class="form-control" [paraTimepickerTrigger]="picker" />
    <para-timepicker #picker [time]="getTime()" (timeChange)="timeChange($event)"></para-timepicker>
  </div>
</ng-template>

<ng-template #task_end_date>
  <div class="form-container">
    <label class="form-label">Data końcowa</label>
    <div class="datepicker-container">
      <input
        matInput
        class="form-control"
        id="task-end-date"
        name="end-date"
        autocomplete="off"
        [matDatepicker]="endDatePicker"
        [ngModel]="getModel().getTask().endDate"
        (ngModelChange)="getModel().getTask().endDate = $event"
        (dateChange)="updateTask()"
      />
      <mat-datepicker-toggle
        [for]="endDatePicker"
        class="datepicker"
      ></mat-datepicker-toggle>
      <mat-datepicker #endDatePicker></mat-datepicker>
    </div>
  </div>
</ng-template>

<ng-template #task_planned_time>
  <div class="form-container">
    <label class="form-label">Planowany czas</label>
    <input
      matInput
      class="form-control"
      id="task-end-date"
      name="end-date"
      autocomplete="off"
      min="1"
      (keyup.enter)="updateTask()"
      (focusout)="updateTask()"
      [ngModel]="getModel().getTask().plannedTime"
      (ngModelChange)="getModel().getTask().plannedTime = $event"
    />
    <mat-datepicker-toggle [for]="endDatePicker" class="datepicker"></mat-datepicker-toggle>
    <mat-datepicker #endDatePicker></mat-datepicker>
  </div>
</ng-template>

<ng-template #task_stage>
  <div class="form-container">
    <label class="form-label">Etap</label>
    <select
      class="form-control"
      name="task-stage"
      [ngModel]="getModel().getTask().projectStageID"
      (ngModelChange)="getModel().getTask().projectStageID = $event"
      (change)="updateTask()"
    >
      <option [ngValue]="null"></option>
      <option *ngFor="let stage of getView().stages" [ngValue]="stage.id">
        {{ stage.name}}
      </option>
    </select>
  </div>
</ng-template>

<ng-template #task_labels_group>
  <div class="labels-list">
    <div
      *ngFor="let label of getModel().getTask().labels"
      class="label-item transparent-border"
    >
      <span class="label-name">
        {{ label.name }}
      </span>
      <span class="remove-icon" (click)="getLabels().removeLabel(label)"></span>
    </div>
  </div>
  <button
    class="create-button"
    id="task-labels"
    name="labels"
    [matMenuTriggerFor]="appMenu"
    (menuClosed)="getLabels().cancelChoosingLabels()"
    (menuOpened)="getLabels().openChoosingLabels()"
  >
    Dodaj
  </button>
  <!-- TODO: można to zrobić w ten sposób, że ostatnią pozycją będzie dodaj inną -->
  <button
    class="simple-button"
    id="manage-label-button"
    (click)="openLabelsManager()"
  >
    Zarzadzaj etykietami
  </button>
</ng-template>

<ng-template #task_subtasks_group>
  <div
    class="list border"
    id="subtask-list"
    cdkDropList
    #subtaskList="cdkDropList"
    [cdkDropListData]="getModel().getFilteredSubtasks()"
    (cdkDropListDropped)="onDrop($event)"
  >
    <div
      *ngFor="let subtask of getModel().getFilteredSubtasks()"
      class="list-item transparent-border"
      cdkDrag
    >
      <ng-container
        [ngTemplateOutlet]="subtask_item"
        [ngTemplateOutletContext]="{ $implicit: subtask }"
      ></ng-container>
      <ng-container
        [ngTemplateOutlet]="subtask_edit"
        [ngTemplateOutletContext]="{ $implicit: subtask }"
      ></ng-container>
    </div>
    <inserting-template (acceptEvent)="getSubtask().addNewSubtask()"></inserting-template>
  </div>
  <button
      class="create-button"
      id="add-subtask-button"
      [hidden]="getSubtask().getModel().isAddingSubtask()"
      (click)="openStepsInserting()"
    >
      Dodaj
    </button>
</ng-template>

<ng-template #subtask_item let-subtask>
  <div
    [ngClass]="{
      'subtask-checkbox-icon': subtask.status == status.STARTED,
      'subtask-done-icon': subtask.status == status.ENDED,
      'subtask-icon': true,
      'checkbox': true
    }"
    (click)="getSubtask().toggleSubtaskStatus(subtask)"
  ></div>
  <div
    class="list-item-value"
    (click)="getSubtask().toggleSubtaskStatus(subtask)"
    *ngIf="!getSubtask().getModel().isEditingSubtask(subtask)"
  >
    {{ subtask.name }}
  </div>
</ng-template>

<ng-template #subtask_edit let-subtask>
  <input
    class="subtask-name"
    value="{{ subtask.name }}"
    [id]="'subtask-name-input_' + subtask.id"
    autocomplete="off"
    *ngIf="getSubtask().getModel().isEditingSubtask(subtask)"
    [ngModel]="getSubtask().getModel().getEditingSubtaskName()"
    (ngModelChange)="getSubtask().getModel().setEditingSubtaskName($event)"
    (keyup)="getSubtask().handleKeysOnEditSubtask($event, subtask)"
  />
  <div class="item-list-buttons">
    <div
      class="edit-item-icon"
      (click)="getSubtask().openEditingSubtask(subtask)"
      *ngIf="!getSubtask().getModel().isEditingSubtask(subtask)"
    ></div>
    <div
      class="remove-item-icon"
      (click)="getSubtask().removeSubtask(subtask)"
      *ngIf="!getSubtask().getModel().isEditingSubtask(subtask)"
    ></div>
  </div>

  <div
    class="accept-item-icon"
    (click)="getSubtask().acceptEditingSubtask(subtask)"
    *ngIf="getSubtask().getModel().isEditingSubtask(subtask)"
  ></div>
</ng-template>
