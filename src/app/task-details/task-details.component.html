<div class="app-panel shadow">
    <h3 class="panel-header">{{model.getTask().getName()}}</h3>
    <form class="form" (keydown.enter)="$event.preventDefault()">

        <mat-expansion-panel class="form-group" [expanded]="true">
            <mat-expansion-panel-header class="form-group-header">
                Nazwa
            </mat-expansion-panel-header>
            <!-- TODO: można dodać opis -->
            <input type="text" class="form-control" id="task-name" name='name'
            [ngModel]='model.getTask().getName()' (ngModelChange)="model.getTask().setName($event)"
            (keyup.enter)="updateTask()" (focusout)="updateTask()">
        </mat-expansion-panel>

        <mat-expansion-panel class="form-group" [expanded]="model.isDescriptionExtended()">
            <mat-expansion-panel-header class="form-group-header">
                Opis
            </mat-expansion-panel-header>
            <textarea class="form-control" id="task-description" name="description" rows="4"
            [ngModel]='model.getTask().getDescription()' (ngModelChange)="model.getTask().setDescription($event)"></textarea>
            <!-- TODO: dopracować  -->
            <button class="button small-button insert-button" (click)="updateTask()">Wstaw</button>
        </mat-expansion-panel>
        
        <mat-expansion-panel class="form-group" [expanded]="model.isStatusExtended()">
            <mat-expansion-panel-header class="form-group-header">
                Stan
            </mat-expansion-panel-header>
            <select class="form-control" id="task-status" name="status"
            [ngModel]='model.getTask().getStatus()' (ngModelChange)="model.getTask().setStatus($event)"
            (change)="updateTask()">
                <option [ngValue]="status.STARTED">Aktywny</option>
                <option [ngValue]="status.ENDED">Zakończony</option>
                <option [ngValue]="status.CANCELED">Anulowany</option>
                <option [ngValue]="status.AWAITING">Oczekujący</option>
            </select>
        </mat-expansion-panel>

        <mat-expansion-panel class="form-group" [expanded]='model.isPriorityExtended()'>
            <mat-expansion-panel-header class="form-group-header">
                Priorytet
            </mat-expansion-panel-header>
            <select class="form-control" id="task-priority" name="priority"
            [ngModel]='model.getTask().getPriority()' (ngModelChange)='model.getTask().setPriority($event)'
            (change)="updateTask()">
            <option [ngValue]="null" ></option>
            <option [ngValue]="priority.LEVEL_1">1</option>
            <option [ngValue]="priority.LEVEL_2">2</option>
            <option [ngValue]="priority.LEVEL_3">3</option>
            <option [ngValue]="priority.LEVEL_4">4</option>
            <option [ngValue]="priority.LEVEL_5">5</option>
        </select>
        </mat-expansion-panel>

        <mat-expansion-panel class="form-group" [expanded]="model.isEndDateExtended()">
            <mat-expansion-panel-header class="form-group-header">
                Data końcowa
            </mat-expansion-panel-header>
            <div class="datepicker-container">
                <input matInput class='form-control' id="task-end-date" name="end-date" [matDatepicker]="endDatePicker"
                [ngModel]='model.getTask().getEndDate()' (ngModelChange)="model.getTask().setEndDate($event)"
                (dateChange)="updateTask()">
                <!-- TODO: być może będzie trzeba to przypisać do zmiany daty -->
                <mat-datepicker-toggle [for]="endDatePicker" class="datepicker"></mat-datepicker-toggle>
                <mat-datepicker #endDatePicker></mat-datepicker>
            </div>  
        </mat-expansion-panel>
      
        <mat-expansion-panel class="form-group" [expanded]="model.isPlannedTimeExtended()">
            <mat-expansion-panel-header class="form-group-header">
                Planowany czas
            </mat-expansion-panel-header>
            <input type='number' class="form-control" id="task-planned_time" name="planned_time"
            [ngModel]="model.getTask().getPlannedTime()" (ngModelChange)="model.getTask().setPlannedTime($event)"
            (keyup.enter)="updateTask()" (focusout)="updateTask()">
        </mat-expansion-panel>

        <mat-expansion-panel class="form-group" [expanded]="model.isLabelsExtended()">
            <mat-expansion-panel-header class="form-group-header">
                Etykiety ({{model.getTask().getLabels().length}})
            </mat-expansion-panel-header>
            <div class="labels-list">
                <div *ngFor="let label of model.getTask().getLabels()" class="label-item transparent-border">
                    <span class="label-name">
                        {{label.getName()}}
                    </span>
                    <span class="remove-label" (click)="removeLabel(label)"></span>
                </div>
            </div>
            <button class="form-control button small-button" id="task-labels" name="labels" [matMenuTriggerFor]="appMenu">Dodaj</button>
            <!-- TODO: można to zrobić w ten sposób, że ostatnią pozycją będzie dodaj inną -->
            <button class="form-control button small-button" id="manage-label-button" (click)="openLabelsManager()">Zarzadzaj etykietami</button>
        </mat-expansion-panel>

        <mat-expansion-panel class="form-group" [expanded]="model.isSubtasksExtended()">
            <mat-expansion-panel-header class="form-group-header">
                Kroki ({{getFinishedSubtasks(model.getTask())}} / {{model.getTask().getSubtasks().length}})
            </mat-expansion-panel-header>
            <div class="list border">
                <div *ngFor="let subtask of model.getTask().getSubtasks()" class="list-item small-list-item transparent-border">
                    <div 
                    [ngClass]="{'subtask-checkbox-icon': subtask.getStatus()==status.STARTED,
                                'subtask-done-icon': subtask.getStatus()==status.ENDED,
                                'subtask-icon':true,
                                'checkbox': true}"
                                (click)="toggleSubtaskStatus(subtask)">
                    </div>
                    <div class="list-item-value" (click)="toggleSubtaskStatus(subtask)"
                    *ngIf="model.getEditedSubtask()!=subtask">{{subtask.getName()}}</div>
                    <input class="subtask-name" value="{{subtask.getName()}}" [id]="'subtask-name-input_' + subtask.getId()"
                    *ngIf="model.getEditedSubtask()==subtask"
                    (keyup)="handleKeysOnEditSubtask($event, subtask)">
                    <div class="subtask-item-buttons">
                        <div class="edit-subtask list-item-options small-list-item-icon" (click)='openEditingSubtask(subtask)'
                        *ngIf="model.getEditedSubtask()!=subtask">E</div>
                        <div class="remove-subtask list-item-options small-list-item-icon" (click)='removeSubtask(subtask)'
                        *ngIf="model.getEditedSubtask()!=subtask">U</div>
                    </div>
                    
                    <div class='edit-accept list-item-options small-list-item-icon' (click)="acceptEditingSubtask(subtask)"
                    *ngIf="model.getEditedSubtask()==subtask">V</div>  
                </div>
            </div>
            <input type="text" class="form-control" id="subtask" [hidden]="!model.isSubtaskEditing()"
            (keyup)="handleKeysOnNewSubtaskInput($event)">
            <div class="buttons-container">
                <button class="button small-button insert-button" id="add-subtask-button" [hidden]="model.isSubtaskEditing()"
                (click)="openAddingSubtask()">
                    Dodaj
                </button>
                <button class="button small-button insert-button" id="save-subtask-button" [hidden]="!model.isSubtaskEditing()"
                (click)="addNewSubtask()">Zapisz</button>
                <button class="button small-button insert-button" id="cancel-subtask-button" [hidden]="!model.isSubtaskEditing()"
                (click)="closeAddingSubtask()">Anuluj</button>
            </div>
        </mat-expansion-panel>
    </form>
    <div class="form-buttons-section">
        <button class="button form-button" id="task-close-button" (click)='closeView()'>Zamknij</button>
    </div>
</div>

<mat-menu #appMenu="matMenu" class="my-menu">
    <button mat-menu-item *ngFor="let label of model.getLabels()" class="list-item small-list-item"
    (click)="chooseLabel(label)">{{label.getName()}}</button>
</mat-menu>